
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>LVS、Haproxy、OSPF负载均衡技术对比 | Anste</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="Anste">
    
    <meta name="description" itemprop="description" content="通过分析lvs、haproxy、ospf负载均衡的特点，确定应用场景">
    
    
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="elfzhao" />
    <meta name="twitter:title" content="LVS、Haproxy、OSPF负载均衡技术对比 | Anste" />
      
        <meta name="twitter:description" content="通过分析lvs、haproxy、ospf负载均衡的特点，确定应用场景" />
      
    
    
    <link rel="alternate" href="/atom.xml" title="Anste" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/catman.png">
    <link rel="apple-touch-icon-precomposed" href="/img/catman.png">
    
    <link rel="stylesheet" type="text/css" href="http://cdn.bootcss.com/font-awesome/4.2.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/style.css" type="text/css">
    
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-28065593-1', 'anste.com');  
ga('send', 'pageview');
</script>



<script type="text/javascript">
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?395b591d268906c0303cf35973bb61a3";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

    <link href='http://fonts.useso.com/css?family=Tangerine:700' rel='stylesheet' type='text/css'>
<link href='http://fonts.useso.com/css?family=Covered+By+Your+Grace' rel='stylesheet' type='text/css'>
<link href='http://fonts.useso.com/css?family=Philosopher' rel='stylesheet' type='text/css'>
</head>

  <body>
    <header>
      <div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="Anste" title="Anste"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Anste">Anste</a></h1>
				<h2 class="blog-motto">A Next Step To Extreme</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					
						<li><a href="/">主页 | Home</a></li>
					
						<li><a href="/tags">标签页 | Tags</a></li>
					
						<li><a href="/categories">分类 | Categories</a></li>
					
						<li><a href="/archives">归档 | Archives</a></li>
					
						<li><a href="/about">关于 | About</a></li>
					
					<li>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/06/10/lvs/" title="LVS、Haproxy、OSPF负载均衡技术对比" itemprop="url">LVS、Haproxy、OSPF负载均衡技术对比</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://www.anste.com" title="Anste">Anste</a>
    </p>
  <p class="article-time">
    <time datetime="2015-06-10T06:48:44.408Z" itemprop="datePublished">2015-06-10</time>
    更新日期:<time datetime="2015-06-10T06:48:44.408Z" itemprop="dateModified">2015-06-10</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#方案概述"><span class="toc-number">1.</span> <span class="toc-text">方案概述</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#LVS"><span class="toc-number">1.1.</span> <span class="toc-text">LVS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HAProxy"><span class="toc-number">1.2.</span> <span class="toc-text">HAProxy</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ospf（ECMP）"><span class="toc-number">1.3.</span> <span class="toc-text">Ospf（ECMP）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#方案测试"><span class="toc-number">2.</span> <span class="toc-text">方案测试</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#测试环境"><span class="toc-number">2.1.</span> <span class="toc-text">测试环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LVS测试"><span class="toc-number">2.2.</span> <span class="toc-text">LVS测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#部署实施"><span class="toc-number">2.2.1.</span> <span class="toc-text">部署实施</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置"><span class="toc-number">2.2.2.</span> <span class="toc-text">配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#验证"><span class="toc-number">2.2.3.</span> <span class="toc-text">验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#功能测试"><span class="toc-number">2.2.4.</span> <span class="toc-text">功能测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#性能测试"><span class="toc-number">2.2.5.</span> <span class="toc-text">性能测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HAProxy测试"><span class="toc-number">2.3.</span> <span class="toc-text">HAProxy测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#部署实施-1"><span class="toc-number">2.3.1.</span> <span class="toc-text">部署实施</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置-1"><span class="toc-number">2.3.2.</span> <span class="toc-text">配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#cat_/usr/local/sbin/haproxy-sh"><span class="toc-number">3.</span> <span class="toc-text">cat /usr/local/sbin/haproxy.sh</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#验证-1"><span class="toc-number">3.0.1.</span> <span class="toc-text">验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#功能测试-1"><span class="toc-number">3.0.2.</span> <span class="toc-text">功能测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#性能测试-1"><span class="toc-number">3.0.3.</span> <span class="toc-text">性能测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ospf测试"><span class="toc-number">3.1.</span> <span class="toc-text">Ospf测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#部署实施-2"><span class="toc-number">3.1.1.</span> <span class="toc-text">部署实施</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置-2"><span class="toc-number">3.1.2.</span> <span class="toc-text">配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#验证-2"><span class="toc-number">3.1.3.</span> <span class="toc-text">验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#功能测试-2"><span class="toc-number">3.1.4.</span> <span class="toc-text">功能测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#性能测试-2"><span class="toc-number">3.1.5.</span> <span class="toc-text">性能测试</span></a></li></ol></li></ol></li></ol>
		</div>
		
		<h1 id="方案概述">方案概述</h1><h2 id="LVS">LVS</h2><p>LVS（Linux Virtual Server）使用集群技术和Linux操作系统实现一个高性能、高可用的服务器，它具有很好的可伸缩性。<br>特点：<br>1、抗负载能力强、是工作在网络4层之上仅作分发之用，没有流量的产生，这个特点也决定了它在负载均衡软件里的性能最强的；<br>2、配置性比较低，这是一个缺点也是一个优点，因为没有可太多配置的东西，所以并不需要太多接触，大大减少了人为出错的几率；<br>3、工作稳定，自身有完整的双机热备方案，如LVS+Keepalived和LVS+Heartbeat，不过我们在项目实施中用得最多的还是LVS/DR+Keepalived；<br>4、无流量，保证了均衡器IO的性能不会收到大流量的影响；<br>5、应用范围比较广，可以对所有应用做负载均衡；<br>6、软件本身不支持正则处理，不能做动静分离，这个就比较遗憾了；其实现在许多网站在这方面都有较强的需求，这个是Nginx/HAProxy+Keepalived的优势所在。<br>7、如果是网站应用比较庞大的话，实施LVS/DR+Keepalived起来就比较复杂了，特别后面有Windows Server应用的机器的话，如果实施及配置还有维护过程就比较复杂了，相对而言，Nginx/HAProxy+Keepalived就简单多了。</p>
<h2 id="HAProxy">HAProxy</h2><p>HAProxy提供高可用性、负载均衡以及基于TCP和HTTP应用的代 理，支持虚拟主机，它是免费、快速并且可靠的一种解决方案。HAProxy特别适用于那些负载特大的web站点，这些站点通常又需要会话保持或七层处理。HAProxy运行在当前的硬件上，完全可以支持数以万计的并发连接。并且它的运行模式使得它可以很简单安全的整合进您当前的架构中， 同时可以保护你的web服务器不被暴露到网络上。<br>特点：<br>1、HAProxy支持虚拟主机<br>2、能够补充Nginx的一些缺点比如Session的保持，Cookie的引导等工作<br>3、支持url检测后端的服务器出问题的检测会有很好的帮助。<br>4、它跟LVS一样，本身仅仅就只是一款负载均衡软件；单纯从效率上来讲HAProxy更会比Nginx有更出色的负载均衡速度，在并发处理上也是优于Nginx的。<br>5、HAProxy可以对Mysql读进行负载均衡，对后端的MySQL节点进行检测和负载均衡，不过在后端的MySQL slaves数量超过10台时性能不如LVS，所以我向大家推荐LVS+Keepalived。<br>6、HAProxy的算法现在也越来越多了，具体有如下8种：<br>①roundrobin，表示简单的轮询，这个不多说，这个是负载均衡基本都具备的；<br>②static-rr，表示根据权重，建议关注；<br>③leastconn，表示最少连接者先处理，建议关注；<br>④source，表示根据请求源IP，这个跟Nginx的IP_hash机制类似，我们用其作为解决session问题的一种方法，建议关注；<br>⑤ri，表示根据请求的URI；<br>⑥rl_param，表示根据请求的URl参数’balance url_param’ requires an URL parameter name；<br>⑦hdr(name)，表示根据HTTP请求头来锁定每一次HTTP请求；<br>⑧rdp-cookie(name)，表示根据据cookie(name)来锁定并哈希每一次TCP请求。</p>
<h2 id="Ospf（ECMP）">Ospf（ECMP）</h2><p>OSPF(Open Shortest Path First开放式最短路径优先）是一个内部网关协议(Interior Gateway Protocol，简称IGP），用于在单一自治系统（autonomous system,AS）内决策路由。<br>ECMP（Equal-CostMultipathRouting）等价多路径，存在多条不同链路到达同一目的地址的网络环境中，如果使用传统的路由技术，发往该目的地址的数据包只能利用其中的一条链路，其它链路处于备份状态或无效状态，并且在动态路由环境下相互的切换需要一定时间，而等值多路径路由协议可以在该网络环境下同时使用多条链路，不仅增加了传输带宽，并且可以无时延无丢包地备份失效链路的数据传输。<br>特点：<br>1.4层负载均衡，效率高<br>2.配置简单，只需安装基于linux的路由软件quagga<br>3.无法进行监控检查，服务异常无法处理<br>4.无session保持等，功能过于简单</p>
<h1 id="方案测试">方案测试</h1><h2 id="测试环境">测试环境</h2><p>LVS服务器<br>IP：192.168.0.9（主） 192.168.0.10（备）<br>CPU：Intel(R) Xeon(R) CPU           E5649  @ 2.53GHz<br>内存：32G<br>网卡：Broadcom NetXtreme II BCM5709 1000Base-T (C0) PCI Express<br>操作系统：CentOS release 5.8 (Final)<br>内核版本：2.6.18-308.8.2.el5<br>Web服务器<br>IP：192.168.0.14      192.168.0.15<br>CPU：Intel(R) Xeon(R) CPU           E5640  @ 2.67GHz<br>内存：32G<br>网卡：Broadcom NetXtreme II BCM5709 1000Base-T (C0) PCI Express<br>操作系统：CentOS release 6.3 (Final)<br>内核版本：2.6.32-220.17.1.el6.x86_64<br>Web服务：apache+php</p>
<h2 id="LVS测试">LVS测试</h2><h3 id="部署实施">部署实施</h3><p>安装<br>Ipvsadm版本：1.2.1<br>Keepalived版本：1.2.1<br>Root用户登录192.168.0.9/10系统依次执行以下命令安装：<br>yum -y install ipvsadm wget gcc gcc-c++ make openssl-devel kernel-devel<br>Wget <a href="http://keepalived.org/software/keepalived-1.2.1.tar.gz" target="_blank" rel="external">http://keepalived.org/software/keepalived-1.2.1.tar.gz</a><br>ln  -s  /usr/src/kernels/2.6.18-308.1.1.el5-x86_64/  /usr/src/linux<br>(将2.6.18-308.1.1.el5-x86_64替换为当前系统内核文件夹即可)<br>tar zxvf keepalived-1.2.3.tar.gz<br>cd keepalived-1.2.3<br>./configure<br>(注意这个步骤要看到以下字样才是正常的)<br>Use IPVS Framework : Yes<br>IPVS sync daemon support : Yes<br>make &amp;&amp; make install</p>
<h3 id="配置">配置</h3><p>cp /usr/local/etc/rc.d/init.d/keepalived /etc/rc.d/init.d/<br>cp /usr/local/etc/sysconfig/keepalived /etc/sysconfig/<br>mkdir /etc/keepalived<br>cp /usr/local/etc/keepalived/keepalived.conf /etc/keepalived/<br>cp /usr/local/sbin/keepalived /usr/sbin/<br>chkconfig —add keepalived<br>chkconfig —level 2345 keepalived on<br>配置keepalived文件<br>vi /etc/keepalived/keepalived.conf<br>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     acassen<span class="decorator">@firewall.loc</span></span><br><span class="line">     failover<span class="decorator">@firewall.loc</span></span><br><span class="line">     sysadmin<span class="decorator">@firewall.loc   接收通知的邮箱</span></span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from Alexandre.Cassen<span class="decorator">@firewall.loc  通知发送邮箱</span></span><br><span class="line">   smtp_server mail01.knet.cn     邮箱服务器</span><br><span class="line">   smtp_connect_timeout <span class="number">30</span></span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER    keepalived状态参数，主为MASTER，备为SLAVE</span><br><span class="line">    interface eth1    keepalived信息发送接口</span><br><span class="line">    virtual_router_id <span class="number">51</span> 虚拟路由ID，同一组LVS需要配置为相同ID</span><br><span class="line">    priority <span class="number">100</span>   优先级，主&gt;备即可</span><br><span class="line">    advert_int <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass <span class="number">1111</span></span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        <span class="number">192.168</span>.0.23  虚拟服务IP</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server <span class="number">192.168</span>.0.23 <span class="number">80</span> &#123; 虚拟服务IP 和端口</span><br><span class="line">    delay_loop <span class="number">6</span></span><br><span class="line">    lb_algo wrr   调度算法</span><br><span class="line">    lb_kind DR    工作模式</span><br><span class="line">    persistence_timeout <span class="number">60</span>  会话保持时间</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    real_server <span class="number">192.168</span>.0.14 <span class="number">80</span> &#123;真实服务IP和端口</span><br><span class="line">        weight <span class="number">1</span></span><br><span class="line">        TCP_CHECK&#123;    健康检查</span><br><span class="line">            connect_timeout <span class="number">10</span></span><br><span class="line">            nb_get_retry <span class="number">3</span></span><br><span class="line">            delay_before_retry <span class="number">3</span></span><br><span class="line">            connect_port <span class="number">80</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">real_server <span class="number">192.168</span>.0.15 <span class="number">80</span> &#123;</span><br><span class="line">        weight <span class="number">1</span></span><br><span class="line">        TCP_CHECK&#123;</span><br><span class="line">            connect_timeout <span class="number">10</span></span><br><span class="line">            nb_get_retry <span class="number">3</span></span><br><span class="line">            delay_before_retry <span class="number">3</span></span><br><span class="line">            connect_port <span class="number">80</span></span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>备机keepalived文件与主大部分相同，只需要更改state和priority字段即可<br>配置Realserver 启动脚本<br>其中红色字段为iptables进行端口转换配置，需要根据相应服务真实端口进行变更。<br>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment"># description: Config realserver lo and apply noarp</span></span><br><span class="line">WEB_VIP=<span class="number">192.168</span>.0.23</span><br><span class="line"></span><br><span class="line">. /etc/rc.d/init.d/functions</span><br><span class="line"></span><br><span class="line">case <span class="string">"$1"</span> <span class="keyword">in</span></span><br><span class="line">start)</span><br><span class="line">        ifconfig lo:<span class="number">0</span> $WEB_VIP netmask <span class="number">255.255</span>.255.255 broadcast $WEB_VIP</span><br><span class="line">        /sbin/route add -host $WEB_VIP dev lo:<span class="number">0</span></span><br><span class="line">        echo <span class="string">"1"</span> &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">        echo <span class="string">"2"</span> &gt;/proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">        echo <span class="string">"1"</span> &gt;/proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">        echo <span class="string">"2"</span> &gt;/proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line">        sysctl -p &gt;/dev/null <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br><span class="line">        echo <span class="string">"RealServer Start OK"</span></span><br><span class="line"></span><br><span class="line">        ;;</span><br><span class="line">stop)</span><br><span class="line">        ifconfig lo:<span class="number">0</span> down</span><br><span class="line">        route <span class="keyword">del</span> $WEB_VIP &gt;/dev/null <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br><span class="line">        echo <span class="string">"0"</span> &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">        echo <span class="string">"0"</span> &gt;/proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">        echo <span class="string">"0"</span> &gt;/proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">        echo <span class="string">"0"</span> &gt;/proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line">        echo <span class="string">"RealServer Stoped"</span></span><br><span class="line">        ;;</span><br><span class="line">status)</span><br><span class="line">         <span class="comment"># Status of LVS-DR real server.</span></span><br><span class="line">         islothere=`/sbin/ifconfig lo:<span class="number">0</span> | grep $WEB_VIP`</span><br><span class="line">         isrothere=`netstat -rn | grep <span class="string">"lo:0"</span> | grep $web_VIP`</span><br><span class="line">         <span class="keyword">if</span> [ ! <span class="string">"$islothere"</span> -o ! <span class="string">"isrothere"</span> ];then</span><br><span class="line">             <span class="comment"># Either the route or the lo:0 device</span></span><br><span class="line">             <span class="comment"># not found.</span></span><br><span class="line">             echo <span class="string">"LVS-DR real server Stopped."</span></span><br><span class="line">         <span class="keyword">else</span></span><br><span class="line">             echo <span class="string">"LVS-DR Running."</span></span><br><span class="line">         fi</span><br><span class="line">;;</span><br><span class="line">*)</span><br><span class="line">         <span class="comment"># Invalid entry.</span></span><br><span class="line">         echo <span class="string">"$0: Usage: $0 &#123;start|status|stop&#125;"</span></span><br><span class="line">         exit <span class="number">1</span></span><br><span class="line">;;</span><br><span class="line">esac</span><br><span class="line">exit <span class="number">0</span></span><br></pre></td></tr></table></figure></p>
<h3 id="验证">验证</h3><p>访问真实服务地址<a href="http://192.168.0.14" target="_blank" rel="external">http://192.168.0.14</a> 应用正常<br>访问真实服务地址<a href="http://192.168.0.15" target="_blank" rel="external">http://192.168.0.15</a> 应用正常<br>访问虚拟服务地址<a href="http://192.168.0.23" target="_blank" rel="external">http://192.168.0.23</a> 应用正常<br>LVS实现负载均衡原理是通过修改mac字段将访问vip的数据包转发到相应realserver，转发要求RIP和DIP（LVS服务器IP）属于同一个网段才可以进行arp广播。所以现有四川三层架构无法支持LVS，需将LVS和RIP（真实服务器IP）修改为同一网段，变动较大，取消测试。</p>
<h3 id="功能测试">功能测试</h3><p>端口转发：DR模式+iptables<br>         LVS配置虚IP 192.168.0.23 端口80 对应真实服务IP 192.168.0.14/15 端口80<br>         真实服务器192.168.0.14/15 使用启动脚本<br>测试结果：正常转发请求<br>主备切换：主LVS停止keepalived服务，service keepalived stop，192.168.0.23端口80服务是否正常<br>测试结果：实时切换到备LVS提供负载均衡服务，服务正常，且用户不会觉察。</p>
<h3 id="性能测试">性能测试</h3><pre><code>压力测试工具：webbench、http_load
</code></pre><p>http_load<br>创建文件#vi urls<br>写入URL:<a href="http://192.168.0.23/index.html" target="_blank" rel="external">http://192.168.0.23/index.html</a><br>然后执行#./http_load -rate 5 -seconds 10 -parallel 500 urls<br>参数含义:<br>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">\-fetches 简写-f ：含义是总计的访问次数</span><br><span class="line">\-rate 简写-r ：含义是每秒的访问频率</span><br><span class="line">\-seconds简写-s ：含义是总计的访问时间</span><br><span class="line">\-parallel 简写-p：并发访问的线程数</span><br><span class="line">urls是一个url 列表，每个url 单独的一行。可以单个页面。</span><br></pre></td></tr></table></figure></p>
<p>返回结果<br>369097 fetches, 1000 max parallel, 2.88368e+09 bytes, in 60.0011 seconds<br>7812.81 mean bytes/connection<br>6151.5 fetches/sec, 4.80605e+07 bytes/sec<br>msecs/connect: 105.766 mean, 9036.84 max, 0.117 min<br>msecs/first-response: 35.2433 mean, 12993.4 max, 0.62 min<br>9 bad byte counts<br>HTTP response codes:<br>  code 200 — 369088</p>
<p>结果分析： 例如<br>219 fetches, 500 max parallel, 1.36262e+06 bytes, in 10.0008 seconds<br>219个请求，最大并发数500，总计传输的数据为1.36262e+06 bytes，运行时间10.0008秒<br>6222 mean bytes/connection<br>每一连接平均传输的数据量1.36262e+06/219=6222<br>21.8982 fetches/sec, 136251 bytes/sec<br>每秒的响应请求为21.8982，每秒传递的数据为136251btyes/sec<br>msecs/connect: 411.015 mean, 9080.76 max, 69.914 min<br>没连接的平均响应时间是411.015 means，最大响应时间9080.76 msecs，最小响应时间69.914 msecs<br>msecs/first-response: 148.292 mean, 3686.02 max, 70.624 min<br>HTTP response codes:<br>code 200 — 219</p>
<p>Webbench<br>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">参数说明：-c表示并发数，-t表示持续时间(秒)</span><br><span class="line">Webbench –c <span class="number">1000</span> –t <span class="number">60</span> http://<span class="number">192.168</span>.0.23/index.html</span><br><span class="line">Webbench - Simple Web Benchmark <span class="number">1.5</span></span><br><span class="line">Copyright (c) Radim Kolar <span class="number">1997</span>-<span class="number">2004</span>, GPL Open Source Software.</span><br><span class="line"></span><br><span class="line">Benchmarking: GET http://<span class="number">192.168</span>.0.23/index.html</span><br><span class="line"><span class="number">1000</span> clients, running <span class="number">60</span> sec.</span><br><span class="line"></span><br><span class="line">Speed=<span class="number">398317</span> pages/min, -<span class="number">17916648</span> bytes/sec.</span><br><span class="line">Requests: <span class="number">398284</span> susceed, <span class="number">33</span> failed.</span><br></pre></td></tr></table></figure></p>
<h2 id="HAProxy测试">HAProxy测试</h2><h3 id="部署实施-1">部署实施</h3><p>安装<br>使用root用户登录192.168.0.9<br>依次运行以下命令：<br>Wget <a href="http://haproxy.1wt.eu/download/1.4/src/haproxy-1.4.21.tar.gz" target="_blank" rel="external">http://haproxy.1wt.eu/download/1.4/src/haproxy-1.4.21.tar.gz</a><br>在haprxoy安装包目录下生成安装脚本haproxy_install.sh<br>  <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">#install haproxy </span><br><span class="line">#20111207 by dongnan</span><br><span class="line"></span><br><span class="line">#variables</span><br><span class="line">dir=/usr/local</span><br><span class="line">ha_dir=$&#123;dir&#125;/haproxy</span><br><span class="line">ha_cfg=$&#123;ha_dir&#125;/haproxy.cfg</span><br><span class="line">kernel=`uname -r | grep '2.6'`</span><br><span class="line">pcre=$(rpm -qa | grep 'pcre' | wc -l)</span><br><span class="line">echo "$dir, $ha_dir, $ha_cfg, $kernel, $pcre"</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#check</span><br><span class="line">if [ ! "$kernel" -o "$pcre" -lt "2" ];then</span><br><span class="line">    echo -e "the script need linux 2.6 kernel and pcre pcre-devel \nyou can usage 'yum install pcre pcre-devel' or 'rpm -ivh pcre-devel-6.6-2.el5_1.7.x86_64.rpm'"</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">#function</span><br><span class="line"></span><br><span class="line">install_ha_cfg ()&#123;</span><br><span class="line">#configure haproxy.cfg</span><br><span class="line">#default configure file for test,but need your change the frontend server and backend server ip address,</span><br><span class="line">#good luck!</span><br><span class="line"></span><br><span class="line">echo '</span><br><span class="line">global</span><br><span class="line">    log 127.0.0.1   local0</span><br><span class="line">    maxconn 40960              #单个进程最大连接数</span><br><span class="line">    chroot /usr/local/haproxy #安装目录</span><br><span class="line">    uid 99                    #用户haproxy</span><br><span class="line">    gid 99                    #组haproxy</span><br><span class="line">    daemon                    #守护进程运行</span><br><span class="line">    nbproc 1                  #进程数量</span><br><span class="line">    pidfile /usr/local/haproxy/logs/haproxy.pid #haproxy pid</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">   log     global</span><br><span class="line">   mode    http               #7层 http;4层tcp</span><br><span class="line">   option  httplog            #http 日志格式</span><br><span class="line">   option  httpclose          #主动关闭http通道</span><br><span class="line">   option  redispatch         #serverId对应的服务器挂掉后,强制定向到其他健康的服务器</span><br><span class="line">   option log-health-checks   #记录健康检查日志</span><br><span class="line">   option  dontlognull        #不记录空连接</span><br><span class="line">   maxconn 30000               #最大连接数</span><br><span class="line">   contimeout      5000       #连接超时(毫秒)</span><br><span class="line">   clitimeout      50000      #客户端超时(毫秒)</span><br><span class="line">   srvtimeout      50000      #服务器超时(毫秒)</span><br><span class="line"></span><br><span class="line">frontend haproxy_kx         #定义前端服务器(haproxy)</span><br><span class="line">        bind 0.0.0.0:80    #监听地址</span><br><span class="line">        default_backend server_pool  #指定后端服务器群</span><br><span class="line">        #errorfile 502 /usr/local/haproxy/html/maintain.html</span><br><span class="line">        #errorfile 503 /usr/local/haproxy/html/maintain.html</span><br><span class="line">        #errorfile 504 /usr/local/haproxy/html/maintain.html</span><br><span class="line"></span><br><span class="line">backend server_pool           #定义后端服务器群(web server/apache/nginx/iis..)</span><br><span class="line">        mode http</span><br><span class="line">        option  forwardfor    #后端服务器(apache/nginx/iis/*),从Http Header中获得客户端IP</span><br><span class="line">        #balance roundrobin    #负载均衡的方式,轮询方式</span><br><span class="line">        balance leastconn     #负载均衡的方式,最小连接</span><br><span class="line">        cookie SERVERID insert nocache       #插入serverid到cookie中,serverid后面可以定义</span><br><span class="line">        #option  httpchk HEAD /check.html #用来做健康检查html文档</span><br><span class="line">        server server1 192.168.0.14:80 cookie server1 check inter 2000 rise 3 fall 3 weight 3</span><br><span class="line">        server server2 192.168.0.15:80 cookie server2 check inter 2000 rise 3 fall 3 weight 3</span><br><span class="line">#服务器定义:</span><br><span class="line">#cookie server1表示serverid为server1;</span><br><span class="line">#check inter 2000 是检测心跳频率(check 默认 );</span><br><span class="line">#rise 3 表示 3次正确认为服务器可用;</span><br><span class="line">#fall 3 表示 3次失败认为服务器不可用;</span><br><span class="line">#weight 表示权重。</span><br><span class="line"></span><br><span class="line">listen admin_stat                   #status</span><br><span class="line">    bind *:8080                     #监听端口</span><br><span class="line">    mode http                       #http的7层模式</span><br><span class="line">    stats refresh 30s               #统计页面自动刷新时间</span><br><span class="line">    stats uri /haproxy-stats        #统计页面URL</span><br><span class="line">    stats realm Haproxy\ Statistics #统计页面密码框上提示文本</span><br><span class="line">    stats auth admin:admin          #统计页面用户名和密码设置</span><br><span class="line">    stats hide-version              #隐藏统计页面上HAProxy的版本信息</span><br><span class="line">    stats admin if TRUE             #手工启用/禁用,后端服务器' &gt; "$ha_cfg" &amp;&amp; sed -i '1 d' "$ha_cfg"</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line"></span><br><span class="line">#install</span><br><span class="line">if [ ! -e "$ha_dir" ];then</span><br><span class="line">   tar zxf haproxy*.tar.gz</span><br><span class="line">   cd haproxy*/</span><br><span class="line">   make TARGET=linux26 USE_STATIC_PCRE=1 PREFIX=/usr/local/haproxy &amp;&amp; make install PREFIX=/usr/local/haproxy &amp;&amp; mkdir /usr/local/haproxy/&#123;html,logs&#125;</span><br><span class="line">   cd ../</span><br><span class="line">#</span><br><span class="line">   if [ ! -e "$ha_dir" ];then</span><br><span class="line">       echo "error! can't install haproxy  please check ! Will now out of the script !"</span><br><span class="line">       exit 1</span><br><span class="line">   else</span><br><span class="line">       ! grep 'haproxy' /etc/syslog.conf &amp;&amp; echo 'local1.*            /var/log/haproxy.log' &gt;&gt; /etc/syslog.conf</span><br><span class="line">       sed -ir 's/SYSLOGD_OPTIONS="-m 0"/SYSLOGD_OPTIONS="-r -m 0"/g' /etc/sysconfig/syslog &amp;&amp; /etc/init.d/syslog restart</span><br><span class="line">       install_ha_cfg</span><br><span class="line">       rm -rf haproxy*/</span><br><span class="line">   fi</span><br><span class="line">else</span><br><span class="line">   echo "haproxy is already exists!"</span><br><span class="line">fi</span><br></pre></td></tr></table></figure></p>
<p>运行脚本安装<br>sh haproxy_install.sh(注意脚本要和安装包在同一个目录下)<br>主备双机热备部署<br>Root用户执行：<br>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum -y install heartbeat</span><br><span class="line">yum -y install heartbeat</span><br><span class="line">cp /usr/share/doc/heartbeat-<span class="number">2.1</span>.3/ha.cf /etc/ha.d/ <span class="comment">#heartbeat主配置文件</span></span><br><span class="line">cp /usr/share/doc/heartbeat-<span class="number">2.1</span>.3/authkeys /etc/ha.d/ <span class="comment">#权限验证文件</span></span><br><span class="line">cp /usr/share/doc/heartbeat-<span class="number">2.1</span>.3/haresources /etc/ha.d/ <span class="comment">#资源配置文件，设置共享IP</span></span><br><span class="line">cd /etc/ha.d</span><br></pre></td></tr></table></figure></p>
<p>vi authkeys<br>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">auth <span class="number">1</span></span><br><span class="line"><span class="number">1</span> crc</span><br></pre></td></tr></table></figure></p>
<p>vi ha.cf<br>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">logfile /var/log/ha-log</span><br><span class="line">logfacility local0</span><br><span class="line">keepalive <span class="number">2</span></span><br><span class="line">deadtime <span class="number">10</span></span><br><span class="line">warntime <span class="number">5</span></span><br><span class="line">initdead <span class="number">120</span></span><br><span class="line">udpport <span class="number">694</span></span><br><span class="line">ucast eth0 <span class="number">192.168</span>.0.9 <span class="comment"># 注意，此处各服务器上的配置不同，此参数应设置为另一台服务器的IP地址</span></span><br><span class="line">auto_failback on</span><br><span class="line">node HA01</span><br><span class="line">node HA02</span><br></pre></td></tr></table></figure></p>
<p>vi haresources<br>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HA01 IPaddr::<span class="number">192.168</span>.0.24/<span class="number">32</span>/eth0（HA01为主节点主机名，<span class="number">192.168</span>.0.24为服务虚地址，<span class="number">32</span>为掩码，eth0为接口）</span><br><span class="line">chkconfig heartbeat on</span><br><span class="line">service heartbeat start(注意先起主服务器heartbeat，等主服务虚地址启用后再起备服务器的heartbeat)</span><br><span class="line">service heartbeat start</span><br></pre></td></tr></table></figure></p>
<h3 id="配置-1">配置</h3><p>生成haproxy启动脚本haproxy.sh<br>内容如下：</p>
<h1 id="cat_/usr/local/sbin/haproxy-sh">cat /usr/local/sbin/haproxy.sh</h1>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment">#haproxy command </span></span><br><span class="line"><span class="comment">#ver:0.1bate</span></span><br><span class="line"><span class="comment">#20111129 by dongnan</span></span><br><span class="line"><span class="comment">#/usr/local/haproxy/sbin/haproxy </span></span><br><span class="line"><span class="comment">#HA-Proxy version 1.4.18 2011/09/16</span></span><br><span class="line"><span class="comment">#Copyright 2000-2011 Willy Tarreau &lt;w@1wt.eu&gt;</span></span><br><span class="line">         <span class="comment">#</span></span><br><span class="line">         <span class="comment">#Usage : haproxy [-f &lt;cfgfile&gt;]* [ -vdVD ] [ -n &lt;maxconn&gt; ] [ -N &lt;maxpconn&gt; ]</span></span><br><span class="line">         <span class="comment">#        [ -p &lt;pidfile&gt; ] [ -m &lt;max megs&gt; ]</span></span><br><span class="line">         <span class="comment">#        -v displays version ; -vv shows known build options.</span></span><br><span class="line">         <span class="comment">#        -d enters debug mode ; -db only disables background mode.</span></span><br><span class="line">         <span class="comment">#        -V enters verbose mode (disables quiet mode)</span></span><br><span class="line">         <span class="comment">#        -D goes daemon</span></span><br><span class="line">         <span class="comment">#        -q quiet mode : don't display messages</span></span><br><span class="line">         <span class="comment">#        -c check mode : only check config files and exit</span></span><br><span class="line">         <span class="comment">#        -n sets the maximum total # of connections (2000)</span></span><br><span class="line">         <span class="comment">#        -m limits the usable amount of memory (in MB)</span></span><br><span class="line">         <span class="comment">#        -N sets the default, per-proxy maximum # of connections (2000)</span></span><br><span class="line">         <span class="comment">#        -p writes pids of all children to this file</span></span><br><span class="line">         <span class="comment">#        -de disables epoll() usage even when available</span></span><br><span class="line">         <span class="comment">#        -ds disables speculative epoll() usage even when available</span></span><br><span class="line">         <span class="comment">#        -dp disables poll() usage even when available</span></span><br><span class="line">         <span class="comment">#        -sf/-st [pid ]* finishes/terminates old pids. Must be last arguments.</span></span><br><span class="line">         </span><br><span class="line">         <span class="comment">#variables</span></span><br><span class="line">         haproxy_dir=/usr/local/haproxy/</span><br><span class="line">         haproxy_conf=$&#123;haproxy_dir&#125;haproxy.cfg</span><br><span class="line">         haproxy_pid=$&#123;haproxy_dir&#125;logs/haproxy.pid</span><br><span class="line">         haproxy_cmd=$&#123;haproxy_dir&#125;sbin/haproxy</span><br><span class="line">         <span class="comment">#test variables</span></span><br><span class="line">         <span class="comment">#file $haproxy_dir; file $haproxy_conf; file $haproxy_cmd; file $haproxy_pid</span></span><br><span class="line">         </span><br><span class="line">         </span><br><span class="line">         </span><br><span class="line">         <span class="keyword">if</span> [ <span class="string">"$#"</span> -eq <span class="string">"0"</span> ];then</span><br><span class="line">             echo <span class="string">"usage: $0 &#123;start|stop|restart&#125;"</span></span><br><span class="line">             exit <span class="number">1</span></span><br><span class="line">         fi</span><br><span class="line">         </span><br><span class="line">         <span class="keyword">if</span> [ <span class="string">"$1"</span> = <span class="string">"start"</span> ];then</span><br><span class="line">         <span class="comment">#echo $1</span></span><br><span class="line">             $haproxy_cmd -f $haproxy_conf</span><br><span class="line">         <span class="keyword">elif</span> [ <span class="string">"$1"</span> = <span class="string">"stop"</span> ];then</span><br><span class="line">         <span class="comment">#echo $1</span></span><br><span class="line">             kill `cat $haproxy_pid`</span><br><span class="line">         <span class="keyword">elif</span> [ <span class="string">"$1"</span> = <span class="string">"restart"</span> ];then</span><br><span class="line">         <span class="comment">#echo $1</span></span><br><span class="line">             $haproxy_cmd -f $haproxy_conf -st `cat $haproxy_pid`</span><br><span class="line">         </span><br><span class="line">         <span class="keyword">else</span></span><br><span class="line">            echo <span class="string">"usage: $0 arguments only start and stop or restart !"</span></span><br><span class="line">     fi</span><br></pre></td></tr></table></figure>
<p>更改文件<br>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Chmod <span class="number">777</span> haproxy_install.sh haproxy.sh</span><br></pre></td></tr></table></figure></p>
<p>在haproxy安装包目录下执行安装脚本，安装完毕，更改haproxy.cfg配置文件<br>     ./haproxy_install.sh<br>     vi /usr/local/haproxy/haproxy.cfg<br>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">global</span></span><br><span class="line">    log <span class="number">127.0</span>.0.1   local0</span><br><span class="line">    maxconn <span class="number">40960</span>              <span class="comment">#最大连接数</span></span><br><span class="line">    chroot /usr/local/haproxy <span class="comment">#安装目录</span></span><br><span class="line">    uid <span class="number">99</span>                    <span class="comment">#用户haproxy</span></span><br><span class="line">    gid <span class="number">99</span>                    <span class="comment">#组haproxy</span></span><br><span class="line">    daemon                    <span class="comment">#守护进程运行</span></span><br><span class="line">    nbproc <span class="number">1</span>                  <span class="comment">#进程数量</span></span><br><span class="line">    pidfile /usr/local/haproxy/logs/haproxy.pid <span class="comment">#haproxy pid</span></span><br><span class="line">    </span><br><span class="line">defaults</span><br><span class="line">   log     <span class="keyword">global</span></span><br><span class="line">   mode    http               <span class="comment">#7层 http;4层tcp </span></span><br><span class="line">   option  httplog            <span class="comment">#http 日志格式</span></span><br><span class="line">   option  httpclose          <span class="comment">#主动关闭http通道</span></span><br><span class="line">   option  redispatch         <span class="comment">#serverId对应的服务器挂掉后,强制定向到其他健康的服务器</span></span><br><span class="line">    </span><br><span class="line">   option  dontlognull</span><br><span class="line">   maxconn <span class="number">30000</span>               <span class="comment">#最大连接数</span></span><br><span class="line">   contimeout      <span class="number">5000</span>       <span class="comment">#连接超时(毫秒)</span></span><br><span class="line">   clitimeout      <span class="number">50000</span>      <span class="comment">#客户端超时(毫秒)</span></span><br><span class="line">   srvtimeout      <span class="number">50000</span>      <span class="comment">#服务器超时(毫秒)</span></span><br><span class="line"> </span><br><span class="line">frontend haproxy_kx         <span class="comment">#定义前端服务器(haproxy)</span></span><br><span class="line">        bind <span class="number">192.168</span>.0.9:<span class="number">80</span>    <span class="comment">#监听地址</span></span><br><span class="line">        default_backend server_pool  <span class="comment">#指定后端服务器群</span></span><br><span class="line">        <span class="comment">#errorfile 502 /usr/local/haproxy/html/maintain.html</span></span><br><span class="line">        <span class="comment">#errorfile 503 /usr/local/haproxy/html/maintain.html</span></span><br><span class="line">        <span class="comment">#errorfile 504 /usr/local/haproxy/html/maintain.html</span></span><br><span class="line"> </span><br><span class="line">backend server_pool           <span class="comment">#定义后端服务器群(web server/apache/nginx/iis..)</span></span><br><span class="line">        mode http</span><br><span class="line">        option  forwardfor    <span class="comment">#后端服务器(apache/nginx/iis/*),从Http Header中获得客户端IP</span></span><br><span class="line">        <span class="comment">#balance roundrobin    #负载均衡的方式,轮询方式</span></span><br><span class="line">        balance leastconn     <span class="comment">#负载均衡的方式,最小连接</span></span><br><span class="line">        cookie SERVERID       <span class="comment">#插入serverid到cookie中,serverid后面可以定义</span></span><br><span class="line">        <span class="comment">#option  httpchk HEAD /check.html #用来做健康检查html文档</span></span><br><span class="line">        server server1 <span class="number">192.168</span>.0.14:<span class="number">80</span> cookie server1 check inter <span class="number">2000</span> rise <span class="number">3</span> fall <span class="number">3</span> weight <span class="number">3</span></span><br><span class="line">        server server2 <span class="number">192.168</span>.0.15:<span class="number">80</span> cookie server2 check inter <span class="number">2000</span> rise <span class="number">3</span> fall <span class="number">3</span> weight <span class="number">3</span></span><br><span class="line">        <span class="comment">#server server3 10.0.1.254:80 cookie server3 check maxconn 90 rise 2 fall 3 weight 3</span></span><br><span class="line"><span class="comment">#服务器定义:</span></span><br><span class="line"><span class="comment">#cookie server1表示serverid为server1;</span></span><br><span class="line"><span class="comment">#check inter 2000 是检测心跳频率(check 默认 );</span></span><br><span class="line"><span class="comment">#rise 3 表示 3次正确认为服务器可用;</span></span><br><span class="line"><span class="comment">#fall 3 表示 3次失败认为服务器不可用;</span></span><br><span class="line"><span class="comment">#weight 表示权重。</span></span><br><span class="line">    </span><br><span class="line">listen admin_stat                   <span class="comment">#status</span></span><br><span class="line">    bind *:<span class="number">8080</span>                     <span class="comment">#监听端口</span></span><br><span class="line">    mode http                       <span class="comment">#http的7层模式</span></span><br><span class="line">    stats refresh <span class="number">30</span>s               <span class="comment">#统计页面自动刷新时间</span></span><br><span class="line">    stats uri /haproxy-stats        <span class="comment">#统计页面URL</span></span><br><span class="line">    stats realm Haproxy\ Statistics <span class="comment">#统计页面密码框上提示文本</span></span><br><span class="line">    stats auth admin:admin          <span class="comment">#统计页面用户名和密码设置</span></span><br><span class="line">    stats hide-version              <span class="comment">#隐藏统计页面上HAProxy的版本信息</span></span><br><span class="line">    stats admin <span class="keyword">if</span> TRUE             <span class="comment">#手工启用/禁用,后端服务器</span></span><br></pre></td></tr></table></figure></p>
<p>启动haproxy<br>     /usr/local/haproxy/haproxy.sh start<br>     查看进程ps –ef | grep haproxy已经运行</p>
<h3 id="验证-1">验证</h3><p>多次访问<a href="http://192.168.0.24" target="_blank" rel="external">http://192.168.0.24</a> 显示相应页面即说明负载成功<br>访问<a href="http://192.168.0.24:8080/haproxy-stats" target="_blank" rel="external">http://192.168.0.24:8080/haproxy-stats</a>  查看当前负载状态<br>默认用户admin 密码admin</p>
<h3 id="功能测试-1">功能测试</h3><p>负载均衡测试<br>多次访问<a href="http://192.168.0.24" target="_blank" rel="external">http://192.168.0.24</a> 显示realserver ip address 在192.168.0.14和<br>192.168.0.15之间切换<br>主备切换测试<br>主192.168.0.9上执行service heartbeat stop<br>虚IP 192.168.0.24漂移到192.168.0.10（备）上，访问服务<a href="http://192.168.0.24" target="_blank" rel="external">http://192.168.0.24</a> 正常<br>主192.168.0.9上执行service heartbeat start<br>虚IP 192.168.0.24漂移回192.168.0.9（主）上，访问服务<a href="http://192.168.0.24" target="_blank" rel="external">http://192.168.0.24</a> 正常</p>
<h3 id="性能测试-1">性能测试</h3><p>http性能测试<br>http_load<br>参数说明 –p  并发用户数 –f  总的访问次数 urllist1 <a href="http://192.168.0.24" target="_blank" rel="external">http://192.168.0.24</a><br>测试1：<br>[root@HA010 ~]# http_load -p 1000 -f 20000 urllist1<br>20000 fetches, 1000 max parallel, 5.4e+06 bytes, in 5.08898 seconds<br>270 mean bytes/connection<br>3930.06 fetches/sec, 1.06112e+06 bytes/sec<br>msecs/connect: 2.59386 mean, 3000.77 max, 0.079 min<br>msecs/first-response: 143.209 mean, 3246.75 max, 1.292 min<br>HTTP response codes:<br>  code 200 – 20000<br>测试2：<br>[root@HA010 ~]# http_load -p 1000 -f 30000 urllist1<br>30000 fetches, 1000 max parallel, 8.1e+06 bytes, in 8.2654 seconds<br>270 mean bytes/connection<br>3629.59 fetches/sec, 979989 bytes/sec<br>msecs/connect: 0.348845 mean, 1.385 max, 0.08 min<br>msecs/first-response: 145.923 mean, 6260.67 max, 5.663 min<br>HTTP response codes:<br>  code 200 – 30000<br>测试3<br>http_load -p 1000 -f 50000 urllist1<br>总访问次数50000 并发1000 导致haproxy服务异常，realserver TCP连接大量time wait<br>Siege<br>参数说明 –c 并发用户数量 –r 重复测试次数 urllist1 <a href="http://192.168.0.24" target="_blank" rel="external">http://192.168.0.24</a><br>测试1：<br>[root@HA010 ~]# siege -c 1000 -r 20 -f urllist1<br><strong> SIEGE 2.72
</strong> Preparing 1000 concurrent users for battle.<br>The server is now under siege..      done.</p>
<p>Transactions:                  20000 hits<br>Availability:                 100.00 %<br>Elapsed time:                  19.25 secs<br>Data transferred:               5.15 MB<br>Response time:                  0.08 secs<br>Transaction rate:            1038.96 trans/sec<br>Throughput:                     0.27 MB/sec<br>Concurrency:                   78.64<br>Successful transactions:       20000<br>Failed transactions:               0<br>Longest transaction:            3.24<br>Shortest transaction:           0.00<br>测试2：<br>[root@HA010 ~]# siege -c 1000 -r 30 -f urllist1<br>*<em> SIEGE 2.72<br>*</em> Preparing 1000 concurrent users for battle.<br>The server is now under siege..      done.</p>
<p>Transactions:                  30000 hits<br>Availability:                 100.00 %<br>Elapsed time:                  26.16 secs<br>Data transferred:               7.72 MB<br>Response time:                  0.06 secs<br>Transaction rate:            1146.79 trans/sec<br>Throughput:                     0.30 MB/sec<br>Concurrency:                   65.63<br>Successful transactions:       30000<br>Failed transactions:               0<br>Longest transaction:            3.15<br>Shortest transaction:           0.00<br>测试3：<br>[root@HA010 ~]# siege -c 1000 -r 50 -f urllist1<br>*<em> SIEGE 2.72<br>*</em> Preparing 1000 concurrent users for battle.<br>The server is now under siege…[error] socket: unable to connect sock.c:222: Connection timed out<br>[error] socket: unable to connect sock.c:222: Connection timed out<br>siege aborted due to excessive socket failure; you<br>can change the failure threshold in $HOME/.siegerc</p>
<p>Transactions:                  37886 hits<br>Availability:                  95.08 %<br>Elapsed time:                  58.34 secs<br>Data transferred:               9.95 MB<br>Response time:                  0.42 secs<br>Transaction rate:             649.40 trans/sec<br>Throughput:                     0.17 MB/sec<br>Concurrency:                  275.07<br>Successful transactions:       37886<br>Failed transactions:            1960<br>Longest transaction:           18.00<br>Shortest transaction:           0.00<br>5%访问无法响应<br>总访问次数50000 并发1000 导致haproxy服务异常，realserver TCP连接大量time wait</p>
<h2 id="Ospf测试">Ospf测试</h2><h3 id="部署实施-2">部署实施</h3><p>安装<br>Web服务器192.168.0.14、192.168.0.15上安装quagga软件<br>Yum install quagga</p>
<h3 id="配置-2">配置</h3><p>配置web服务器quagga<br>使用root用户登录192.168.0.14和192.168.0.15<br>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/quagga</span><br><span class="line">cp ospfd.conf.sample ospfd.conf</span><br><span class="line">chkconfig zebra on</span><br><span class="line">chkconfig ospfd on</span><br><span class="line">service zebra start</span><br><span class="line">service ospfd start</span><br><span class="line">telnet localhost ospfd</span><br><span class="line">输入默认密码zebra</span><br><span class="line">ospfd&gt; en</span><br><span class="line">ospfd<span class="comment"># conf t</span></span><br><span class="line">ospfd(config)<span class="comment"># router ospf</span></span><br><span class="line">ospfd(config-router)<span class="comment"># router-id 192.168.2.66</span></span><br><span class="line">ospfd(config-router)<span class="comment"># network 192.168.0.23/32 area 0.0.0.0(lo IP)</span></span><br><span class="line">ospfd(config-router)<span class="comment"># network 192.168.2.64/30 area 0.0.0.0（接口IP）</span></span><br><span class="line">ospfd(config-router)<span class="comment">#end</span></span><br><span class="line">ospfd<span class="comment">#wr</span></span><br></pre></td></tr></table></figure></p>
<p>配置交换机端<br>根据交换机类型配置ospf与主机quagga建立ospf邻居关系<br>配置主机<br>使用root用户分别在2台web服务上执行以下命令<br>ifconfig lo:0 192.168.0.23 netmask 255.255.255.255 up</p>
<h3 id="验证-2">验证</h3><p>多次访问<a href="http://192.168.0.23" target="_blank" rel="external">http://192.168.0.23</a> 显示相应页面即说明负载成功</p>
<h3 id="功能测试-2">功能测试</h3><p>负载均衡测试<br>多次访问<a href="http://192.168.0.23" target="_blank" rel="external">http://192.168.0.23</a> 显示realserver ip address 在192.168.0.14和<br>192.168.0.15之间切换<br>服务切换测试<br>Down掉192.168.0.14/15上的服务IP 192.168.0.23可以正常访问应用</p>
<h3 id="性能测试-2">性能测试</h3><p>http性能测试<br>http_load<br>参数说明 –p  并发用户数 –f  总的访问次数 urllist1 <a href="http://192.168.0.23" target="_blank" rel="external">http://192.168.0.23</a><br>        测试1：<br>[root@HA010 ~]# http_load -p 1000 -f 20000 urllist2<br>20000 fetches, 1000 max parallel, 5.4e+06 bytes, in 5.16173 seconds<br>270 mean bytes/connection<br>3874.67 fetches/sec, 1.04616e+06 bytes/sec<br>msecs/connect: 128.888 mean, 3001.72 max, 0.068 min<br>msecs/first-response: 25.953 mean, 3031.86 max, 0.63 min<br>HTTP response codes:<br>  code 200 – 20000<br>测试2：<br>[root@HA010 ~]# http_load -p 1000 -f 30000 urllist2<br>30000 fetches, 1000 max parallel, 8.1e+06 bytes, in 5.72167 seconds<br>270 mean bytes/connection<br>5243.23 fetches/sec, 1.41567e+06 bytes/sec<br>msecs/connect: 84.9997 mean, 3001.48 max, 0.062 min<br>msecs/first-response: 18.0883 mean, 2813.84 max, 0.605 min<br>HTTP response codes:<br>  code 200 – 30000<br>测试3：<br>[root@HA010 ~]# http_load -p 1000 -f 50000 urllist2<br>50000 fetches, 1000 max parallel, 1.35e+07 bytes, in 8.0187 seconds<br>270 mean bytes/connection<br>6235.43 fetches/sec, 1.68356e+06 bytes/sec<br>msecs/connect: 101.749 mean, 3001.27 max, 0.07 min<br>msecs/first-response: 16.8017 mean, 1964.43 max, 0.601 min<br>HTTP response codes:<br>  code 200 – 50000<br>总访问次数50000 并发1000，有TCP time wait，但http_load返回正常<br>测试4：<br>[root@HA010 ~]# http_load -p 1000 -f 100000 urllist2<br>总访问次数100000 并发1000 导致TCP连接大量time wait</p>
<p>Siege<br>参数说明 –c 并发用户数量 –r 重复测试次数 urllist1 <a href="http://192.168.0.23" target="_blank" rel="external">http://192.168.0.23</a><br>测试1：<br>[root@HA010 ~]# siege -c 1000 -r 20 -f urllist2<br><strong> SIEGE 2.72
</strong> Preparing 1000 concurrent users for battle.<br>The server is now under siege..      done.</p>
<p>Transactions:                  20000 hits<br>Availability:                 100.00 %<br>Elapsed time:                  19.16 secs<br>Data transferred:               5.15 MB<br>Response time:                  0.03 secs<br>Transaction rate:            1043.84 trans/sec<br>Throughput:                     0.27 MB/sec<br>Concurrency:                   30.30<br>Successful transactions:       20000<br>Failed transactions:               0<br>Longest transaction:            3.01<br>Shortest transaction:           0.00<br>测试2：<br>[root@HA010 ~]# siege -c 1000 -r 30 -f urllist2<br><strong> SIEGE 2.72
</strong> Preparing 1000 concurrent users for battle.<br>The server is now under siege..      done.</p>
<p>Transactions:                  30000 hits<br>Availability:                 100.00 %<br>Elapsed time:                  24.14 secs<br>Data transferred:               7.72 MB<br>Response time:                  0.01 secs<br>Transaction rate:            1242.75 trans/sec<br>Throughput:                     0.32 MB/sec<br>Concurrency:                   15.34<br>Successful transactions:       30000<br>Failed transactions:               0<br>Longest transaction:            3.00<br>Shortest transaction:           0.00<br>测试3：<br>[root@HA010 ~]# siege -c 1000 -r 50 -f urllist2<br><strong> SIEGE 2.72
</strong> Preparing 1000 concurrent users for battle.<br>The server is now under siege..      done.</p>
<p>Transactions:                  50000 hits<br>Availability:                 100.00 %<br>Elapsed time:                  37.18 secs<br>Data transferred:              12.87 MB<br>Response time:                  0.01 secs<br>Transaction rate:            1344.81 trans/sec<br>Throughput:                     0.35 MB/sec<br>Concurrency:                    9.42<br>Successful transactions:       50000<br>Failed transactions:               0<br>Longest transaction:            3.01<br>Shortest transaction:           0.00<br>总访问次数50000 并发1000，有TCP time wait，但siege返回正常<br>测试4：<br>[root@HA010 ~]# siege -c 1000 -r 100 -f urllist2<br><strong> SIEGE 2.72
</strong> Preparing 1000 concurrent users for battle.<br>The server is now under siege..      done.</p>
<p>Transactions:                 100000 hits<br>Availability:                 100.00 %<br>Elapsed time:                  66.28 secs<br>Data transferred:              25.75 MB<br>Response time:                  0.01 secs<br>Transaction rate:            1508.75 trans/sec<br>Throughput:                     0.39 MB/sec<br>Concurrency:                    9.66<br>Successful transactions:      100000<br>Failed transactions:               0<br>Longest transaction:            3.02<br>Shortest transaction:           0.00<br>总访问次数100000 并发1000，有TCP time wait，但siege返回正常</p>
<p>测试用PHP主页代码<br>  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">&lt;?php</span></span><br><span class="line"></span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">'time'</span>] =date(<span class="string">"Y:m:d:H:s"</span>,time());</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"time"</span>.<span class="string">"&lt;font color=red&gt;"</span>.<span class="variable">$_SESSION</span>[<span class="string">'time'</span>].<span class="string">"&lt;/font&gt;"</span>.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"realserver ip address"</span>.<span class="string">"&lt;font color=red&gt;"</span>.<span class="variable">$_SERVER</span>[<span class="string">'SERVER_ADDR'</span>].<span class="string">"&lt;/font&gt;"</span>.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"local address"</span>.<span class="string">"&lt;font color=red&gt;"</span>.<span class="variable">$_SERVER</span>[<span class="string">'SERVER_NAME'</span>].<span class="string">"&lt;/font&gt;"</span>.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"SESSIONNAME"</span>.<span class="string">"&lt;font color=red&gt;"</span>.session_name().<span class="string">"&lt;/font&gt;"</span>.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"SESSIONID"</span>.<span class="string">"&lt;font color=red&gt;"</span>.session_id().<span class="string">"&lt;/font&gt;"</span>.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">?&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>查看主机TCP连接情况<br>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -nat|awk <span class="string">'&#123;print awk $NF&#125;'</span>|sort|uniq -c|sort -n</span><br></pre></td></tr></table></figure></p>
  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/haproxy/">haproxy</a><a href="/tags/lvs/">lvs</a><a href="/tags/ospf/">ospf</a>
  </div>


<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Linux/">Linux</a>
</div>



<div class="article-share" id="share">

  
<div class="jiathis_style">
    <span class="jiathis_txt">分享到：</span>
    <a class="jiathis_button_tsina">新浪微博</a>
    <a class="jiathis_button_weixin">微信</a>
    <a class="jiathis_button_twitter">Twitter</a>
    <a class="jiathis_button_evernote">EverNote</a>
    <a href="http://www.jiathis.com/share?uid=1501277" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
</div>
<script type="text/javascript" >
    var jiathis_config={
    data_track_clickback:true,
    sm:"copy,renren,cqq",
    pic:"",
    summary:"",
     ralateuid:{"tsina":"readortravel"},hideMore:false}
    
  </script> 
<script type="text/javascript" src="//v3.jiathis.com/code/jia.js?uid=
elfzhao@hotmail.com" charset="utf-8"></script>      


</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2015/06/11/openstack-Windows2012/" title="openstack windows2012镜像文件制作教程">
  <strong>PREVIOUS:</strong><br/>
  <span>
  openstack windows2012镜像文件制作教程</span>
</a>
</div>


<div class="next">
<a href="/2015/06/10/Openstack-CentOS/"  title="Openstack CentOS镜像制作教程">
 <strong>NEXT:</strong><br/> 
 <span>Openstack CentOS镜像制作教程
</span>
</a>
</div>

</nav>

	
<section class="comment">
	<div class="ds-thread" data-thread-key="2015/06/10/lvs/" data-title="LVS、Haproxy、OSPF负载均衡技术对比" data-url="http://www.anste.com/2015/06/10/lvs/"></div>
</section>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#方案概述"><span class="toc-number">1.</span> <span class="toc-text">方案概述</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#LVS"><span class="toc-number">1.1.</span> <span class="toc-text">LVS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HAProxy"><span class="toc-number">1.2.</span> <span class="toc-text">HAProxy</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ospf（ECMP）"><span class="toc-number">1.3.</span> <span class="toc-text">Ospf（ECMP）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#方案测试"><span class="toc-number">2.</span> <span class="toc-text">方案测试</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#测试环境"><span class="toc-number">2.1.</span> <span class="toc-text">测试环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LVS测试"><span class="toc-number">2.2.</span> <span class="toc-text">LVS测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#部署实施"><span class="toc-number">2.2.1.</span> <span class="toc-text">部署实施</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置"><span class="toc-number">2.2.2.</span> <span class="toc-text">配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#验证"><span class="toc-number">2.2.3.</span> <span class="toc-text">验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#功能测试"><span class="toc-number">2.2.4.</span> <span class="toc-text">功能测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#性能测试"><span class="toc-number">2.2.5.</span> <span class="toc-text">性能测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HAProxy测试"><span class="toc-number">2.3.</span> <span class="toc-text">HAProxy测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#部署实施-1"><span class="toc-number">2.3.1.</span> <span class="toc-text">部署实施</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置-1"><span class="toc-number">2.3.2.</span> <span class="toc-text">配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#cat_/usr/local/sbin/haproxy-sh"><span class="toc-number">3.</span> <span class="toc-text">cat /usr/local/sbin/haproxy.sh</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#验证-1"><span class="toc-number">3.0.1.</span> <span class="toc-text">验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#功能测试-1"><span class="toc-number">3.0.2.</span> <span class="toc-text">功能测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#性能测试-1"><span class="toc-number">3.0.3.</span> <span class="toc-text">性能测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ospf测试"><span class="toc-number">3.1.</span> <span class="toc-text">Ospf测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#部署实施-2"><span class="toc-number">3.1.1.</span> <span class="toc-text">部署实施</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置-2"><span class="toc-number">3.1.2.</span> <span class="toc-text">配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#验证-2"><span class="toc-number">3.1.3.</span> <span class="toc-text">验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#功能测试-2"><span class="toc-number">3.1.4.</span> <span class="toc-text">功能测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#性能测试-2"><span class="toc-number">3.1.5.</span> <span class="toc-text">性能测试</span></a></li></ol></li></ol></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  
  <div class="tagcloudlist">
    <p class="asidetitle">标签云</p>
    <div class="tagcloudlist clearfix">
       <a href="/tags/haproxy/" style="font-size: 10px;">haproxy</a> <a href="/tags/linux/" style="font-size: 20px;">linux</a> <a href="/tags/lvs/" style="font-size: 10px;">lvs</a> <a href="/tags/openstack/" style="font-size: 20px;">openstack</a> <a href="/tags/ospf/" style="font-size: 10px;">ospf</a> <a href="/tags/puppet/" style="font-size: 10px;">puppet</a> <a href="/tags/windows/" style="font-size: 10px;">windows</a>
    </div>
  </div>


  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
			<li><a href="/categories/Linux/" title="Linux">Linux<sup>2</sup></a></li>
		
			<li><a href="/categories/openstack/" title="openstack">openstack<sup>2</sup></a></li>
		
		</ul>
</div>


  
<div class="commentslist">
  <p class="asidetitle">最新评论</p>
  <ul class="ds-recent-comments" data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="1" data-excerpt-length="32" data-show-title="1"></ul>
</div>
<script type="text/javascript">
if(typeof duoshuoQuery === 'undefined'){
  var duoshuoQuery = {short_name:"anste"};
  (function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	}
	</script>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
      <li><a href="http://blog.leafh.pw" target="_blank" title="Leaf Hsiao">Leaf's Blog</a></li>
      <li><a href="http://hexo.io" target="_blank" title="Hexo">Hexo</a></li>
    </ul>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	
	<section class="info">
		<p> 天行健，君子以自强不息；地势坤，君子以厚德载物。 <br/>
			Stay hungry, stay foolish</p>
	</section>
	 
	<div class="social-font clearfix">
		
		<a href="http://weibo.com/readortravel" target="_blank" title="weibo"></a>
		
		
		<a href="https://twitter.com/elfzhao" target="_blank" title="twitter"></a>
		
		
		
		<a href="https://www.facebook.com/atlantis2012" target="_blank" title="facebook"></a>
		
		
        <a href="https://cn.linkedin.com/in/jameschao2015" target="_blank" title="linkedin"></a>
        
	</div>
		<p class="copyright">Powered by <a href="http://zespia.tw/hexo/" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/leaf-hsiao/catman" target="_blank" title="Catman">Catman</a> © 2015 
		
		<a href="http://www.anste.com" target="_blank" title="Anste">Anste</a>
		
		</p>
</div>
</footer>
    <script src="http://cdn.bootcss.com/jquery/2.1.3/jquery.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,208-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      m = $('#main'),
      a = $('#asidepart'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside'),
      w  = $(window).width();
  if ( w>1070 ) {
  	m.addClass('moveMain');
  	a.css('display', 'none').addClass('fadeIn');
  	o.css('display', 'block');
  };
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
  	if ( w>1070 ) {
  	  ta.css('display', 'block').addClass('fadeIn');
  	};
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,250-$(this).scrollTop()));
    });
  };
});
</script>



<script type="text/javascript">
  var duoshuoQuery = {short_name:"anste"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script>





  </body>
</html>
